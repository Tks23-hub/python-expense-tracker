{% extends 'base.html' %}

{% block title %}Dashboard â€“ Expense Tracker{% endblock %}

{% block content %}
  <h1 class="mb-4">Your Expenses</h1>

  <!-- Filter Form -->
  <form class="row g-3 mb-4" method="get" action="{{ url_for('index') }}">
    <div class="col-md-3">
      <label for="start_date" class="form-label">Start Date</label>
      <input
        type="date"
        id="start_date"
        name="start_date"
        class="form-control"
        value="{{ start_date or '' }}"
      />
    </div>
    <div class="col-md-3">
      <label for="end_date" class="form-label">End Date</label>
      <input
        type="date"
        id="end_date"
        name="end_date"
        class="form-control"
        value="{{ end_date or '' }}"
      />
    </div>
    <div class="col-md-3">
      <label for="category" class="form-label">Category</label>
      <select
        id="category"
        name="category"
        class="form-select"
      >
        <option value="">All</option>
        {% for c in categories %}
          <option
            value="{{ c }}"
            {% if c == selected_category %}selected{% endif %}
          >{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3 align-self-end">
      <button type="submit" class="btn btn-primary">Filter</button>
      <a href="{{ url_for('index') }}" class="btn btn-secondary ms-2">Reset</a>
    </div>
  </form>

  {% if expenses %}
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Date</th>
          <th>Category</th>
          <th>Description</th>
          <th class="text-end">Amount</th>
          <th></th> <!-- Edit -->
          <th></th> <!-- Delete -->
        </tr>
      </thead>
      <tbody>
        {% for e in expenses %}
          <tr>
            <td>{{ e.date.strftime('%Y-%m-%d') }}</td>
            <td>{{ e.category }}</td>
            <td>{{ e.description }}</td>
            <td class="text-end">${{ '%.2f'|format(e.amount) }}</td>
            <td class="text-center">
              <a
                href="{{ url_for('edit_expense', expense_id=e.id) }}"
                class="btn btn-sm btn-secondary"
              >Edit</a>
            </td>
            <td class="text-center">
              <form
                method="post"
                action="{{ url_for('delete_expense', expense_id=e.id) }}"
                onsubmit="return confirm('Delete this expense?');"
              >
                <button type="submit" class="btn btn-sm btn-danger">
                  Delete
                </button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="text-muted">
      No expenses recorded yet.
      <a href="{{ url_for('add_expense') }}">Add one now.</a>
    </p>
  {% endif %}

  <h2 class="mt-5">Spending by Category</h2>
  <canvas id="expenseChart" height="100"></canvas>
{% endblock %}

{% block scripts %}
<script>
  // Build query parameters from filter values
  const params = new URLSearchParams({
    start_date: '{{ start_date or "" }}',
    end_date:   '{{ end_date or "" }}',
    category:   '{{ selected_category or "" }}'
  });

  fetch('{{ url_for("data") }}?' + params.toString())
    .then(res => res.json())
    .then(data => {
      const ctx = document
        .getElementById("expenseChart")
        .getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.categories,
          datasets: [
            {
              label: "Total Spent",
              data: data.totals
            }
          ]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    });
</script>
{% endblock %}
